{% extends 'base.html.twig' %}

{% block title %}
	Chat
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	{{ encore_entry_script_tags('chat_send') }}
{% endblock %}


{% set userId1 = app.user.id %}
{% set userId2 = receiver.id %}
{% set conversationChatPath = 'http://localhost:8000/chat/messages/' ~ (userId1 < userId2 ? userId1 ~ '/' ~ userId2 : userId2 ~ '/' ~ userId1) %}

{% block body %}
	<section class="pt-3">
		<div class="container">
			<div class="row">
				<div class="col-lg-4 col-xl-3">
					<div class="offcanvas-lg offcanvas-end" tabindex="-1" id="offcanvasSidebar">
						<div class="offcanvas-header justify-content-end pb-2">
							<button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasSidebar" aria-label="Close"></button>
						</div>
						<div class="offcanvas-body p-3 p-lg-0">
							<div class="card bg-light w-100">
								<div class="card-body p-3">
									{{ include('chat/_user_list.html.twig', {'users': users, 'receiverId': receiver.id}) }}
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-8 col-xl-9">

					<div class="d-grid mb-0 d-lg-none w-100">
						<button class="btn btn-primary mb-4" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
							<i class="fas fa-sliders-h"></i>
							List des utilisateurs
						</button>
					</div>

					<div class="vstack gap-4">
						<div class="card border">
							<div class="card-header">
								{{ receiver.email }}
							</div>
							<div class="card-body" id="messages-container">
								{% for message in messages %}
									{% include "chat/_message_card.html.twig" %}
								{% else %}
									<div class="fs-1 text-center" id="empty-text">
										Veuillez commencer à écrire
									</div>
								{% endfor %}
							</div>
							<div class="card-footer">

								{{ form_start(form, {
									'attr': {
										'novalidate': true,
										'id': 'message-form',
										'action': path('api_chat_send', { id: receiver.id }),
										'data-chat-user': conversationChatPath
									}
								}) }}
								<div class="mb-3" id="content-row">
									{{ form_label(form.content) }}
									{{ form_widget(form.content) }}
								</div>
								<button type="submit" class="btn btn-primary">Envoyer</button>
								{{ form_end(form) }}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

{% endblock %}

{% block script %}
	<script>
		const eventSource = new EventSource("{{ mercure(conversationChatPath)|escape('js') }}");
		eventSource.onmessage = event => {
			const { message, receiverId } = JSON.parse(event.data)
			console.log(message, receiverId)
			if (receiverId !== {{ receiver.id }}){
				const messageCard = document.createElement('div');
				messageCard.innerHTML = `
					<div class="row mt-2">
						<div class="col-md-10">
							<span class="bg-primary px-2 py-1 rounded text-white">
								${message}
							</span>
						</div>
					</div>
				`;
				document.querySelector("#messages-container").append(messageCard)
			}
			}
	</script>
{% endblock %}
